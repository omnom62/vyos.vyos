---
- ansible.builtin.include_tasks: _remove_config.yaml

- name: ensure facts
  include_tasks: _get_version.yaml

- name: Setup 1.3-
  vyos.vyos.vyos_config:
    lines:
      - set firewall group address-group 'inbound'
      - set firewall ipv6-name UPLINK default-action 'accept'
      - set firewall ipv6-name UPLINK description 'This is ipv6 specific rule-- set'
      - set firewall ipv6-name UPLINK rule 1 action 'accept'
      - set firewall ipv6-name UPLINK rule 1 description 'Fwipv6-Rule 1 is configured by Ansible'
      - set firewall ipv6-name UPLINK rule 1 ipsec 'match-ipsec'
      - set firewall ipv6-name UPLINK rule 2 action 'accept'
      - set firewall ipv6-name UPLINK rule 2 description 'Fwipv6-Rule 2 is configured by Ansible'
      - set firewall ipv6-name UPLINK rule 2 ipsec 'match-ipsec'
      - set firewall name INBOUND default-action 'accept'
      - set firewall name INBOUND description 'IPv4 INBOUND rule - set'
      - set firewall name INBOUND rule 101 action 'accept'
      - set firewall name INBOUND rule 101 description 'Rule 101 is configured by Ansible'
      - set firewall name INBOUND rule 101 ipsec 'match-ipsec'
      - set firewall name INBOUND rule 102 action 'reject'
      - set firewall name INBOUND rule 102 description 'Rule 102 is configured by Ansible'
      - set firewall name INBOUND rule 102 ipsec 'match-ipsec'
      - set firewall name INBOUND rule 103 action 'accept'
      - set firewall name INBOUND rule 103 description 'Rule 103 is configured by Ansible'
      - set firewall name INBOUND rule 103 destination group address-group 'inbound'
      - set firewall name INBOUND rule 103 source address '192.0.2.0'
      - set firewall name INBOUND rule 103 state established 'enable'
      - set firewall name INBOUND rule 103 state invalid 'disable'
      - set firewall name INBOUND rule 103 state new 'disable'
      - set firewall name INBOUND rule 103 state related 'enable'
  vars:
    ansible_connection: ansible.netcommon.network_cli
  when: vyos_version is version('1.4.0', '<', version_type='semver')

- name: Setup 1.4+
  vyos.vyos.vyos_config:
    lines:
      - set firewall group address-group 'inbound'
      - set firewall ipv6 name UPLINK default-action 'accept'
      - set firewall ipv6 name UPLINK description 'This is ipv6 specific rule-- set'
      - set firewall ipv6 name UPLINK rule 1 action 'accept'
      - set firewall ipv6 name UPLINK rule 1 description 'Fwipv6-Rule 1 is configured by Ansible'
      - set firewall ipv6 name UPLINK rule 1 ipsec 'match-ipsec'
      - set firewall ipv6 name UPLINK rule 2 action 'accept'
      - set firewall ipv6 name UPLINK rule 2 description 'Fwipv6-Rule 2 is configured by Ansible'
      - set firewall ipv6 name UPLINK rule 2 ipsec 'match-ipsec'
      - set firewall ipv4 name INBOUND default-action 'accept'
      - set firewall ipv4 name INBOUND description 'IPv4 INBOUND rule - set'
      - set firewall ipv4 name INBOUND rule 101 action 'accept'
      - set firewall ipv4 name INBOUND rule 101 description 'Rule 101 is configured by Ansible'
      - set firewall ipv4 name INBOUND rule 101 ipsec 'match-ipsec'
      - set firewall ipv4 name INBOUND rule 102 action 'reject'
      - set firewall ipv4 name INBOUND rule 102 description 'Rule 102 is configured by Ansible'
      - set firewall ipv4 name INBOUND rule 102 ipsec 'match-ipsec'
      - set firewall ipv4 name INBOUND rule 103 action 'accept'
      - set firewall ipv4 name INBOUND rule 103 description 'Rule 103 is configured by Ansible'
      - set firewall ipv4 name INBOUND rule 103 destination group address-group 'inbound'
      - set firewall ipv4 name INBOUND rule 103 source address '192.0.2.0'
      - set firewall ipv4 name INBOUND rule 103 state established
      - set firewall ipv4 name INBOUND rule 103 state related
  vars:
    ansible_connection: ansible.netcommon.network_cli
  when: vyos_version is version('1.4.0', '>=', version_type='semver')
